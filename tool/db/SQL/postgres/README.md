
# Postgresql replication and backup streaming

### 1. Install

install postgres on your master server and other slaves with docker command

``` bash
    cd master
    docker-compose -f docker-postgres.compose.yml up -d
``` 

check the configs of postgresql and pg_hba is like the files that exist in configs directory next the master directory.

you must set it on your own postgres configs

### 2. On master database 

On the master database, you must run this query on postgres base database

1. Create the replicator user on master
``` SQL
    CREATE USER replicator WITH REPLICATION ENCRYPTED PASSWORD 'my_replicator_password';
```

2. Create the physical replication slot on master
``` SQL
    SELECT * FROM pg_create_physical_replication_slot('replication_slot_slave1');
```

NOTE: To see that the physical replication slot has been created successfully, you could run this query 
``` $ SELECT * FROM pg_replication_slots;``` 

3. We need to get a backup from our master database and restore it for the slave. The best way for doing this is to usepg_basebackup command.

``` bash
    pg_basebackup -D /tmp/postgresslave -S replication_slot_slave1 -X stream -P -U replicator -Fp -R
```

run it on your postgres master container.

4. For copy the files from docker container to other hosts ...
``` bash
    docker cp postgres:/tmp/postgresslave postgresslave
```
copy to another host
``` bash
    scp -r postgresslave root@x.x.x.x:/path
```

### The Trick !

1. When you push the postgres data from master server to the host, then you must move it on postgres location data of docker-compose file volume of slave.

2. Since you have run the pg_basebackup inside a docker container and also asked for recovery config file, it has created a postgresql.auto.conf file inside the data-slave directory. In this file you should see something like this.

```
# Do not edit this file manually!
# It will be overwritten by the ALTER SYSTEM command.primary_conninfo = 'user=replicator passfile=''/root/.pgpass'' channel_binding=prefer port=5432 sslmode=prefer sslcompression=0 ssl_min_protocol_version=TLSv1.2 gssencmode=prefer krbsrvname=postgres 

target_session_attrs=any'primary_slot_name = 'replication_slot_proxy_slave1'
```

Now you could see the primary_conninfo which tells the slave how should connect to the master, but these configurations are not right. Letâ€™s change the primy_conninfo and pass the correct information for connecting to master.
```
primary_conninfo = 'host=master-host-ip port=5432 user=replicator password=my_replicator_password'
```
Also we need to add a restore command which tells slave how to deal with this backup, so add this line as well.

```
restore_command = 'cp /var/lib/postgresql/data/pg_wal/%f "%p"'
```
